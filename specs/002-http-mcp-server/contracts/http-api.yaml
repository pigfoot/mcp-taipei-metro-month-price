openapi: 3.1.0
info:
  title: MCP HTTP Server API
  version: 1.0.0
  description: |
    HTTP API for TPASS Calculator MCP Server.

    This server implements the MCP (Model Context Protocol) over HTTP with Server-Sent Events (SSE) streaming support.

    **Primary endpoint**: `/mcp` - MCP protocol endpoint (handled by StreamableHTTPServerTransport)
    **Health endpoint**: `/healthz` - Server health check

    The MCP endpoint follows the MCP Streamable HTTP specification and is primarily used by AI clients.

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: http://localhost:{port}
    description: Configurable port via MCP_PORT environment variable
    variables:
      port:
        default: '3000'

paths:
  /healthz:
    get:
      summary: Health check endpoint
      description: Returns server health status and metadata
      operationId: healthCheck
      tags:
        - Monitoring
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
              examples:
                healthy:
                  value:
                    status: healthy
                    server:
                      name: mcp-taipei-metro-month-price
                      version: 1.0.0
                      uptime: 3600
                    mcp:
                      connected: true
                      toolsAvailable: 2
                    timestamp: '2025-10-29T10:30:00.000Z'
        '503':
          description: Server is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
              examples:
                unhealthy:
                  value:
                    status: unhealthy
                    server:
                      name: mcp-taipei-metro-month-price
                      version: 1.0.0
                      uptime: 120
                    mcp:
                      connected: false
                      toolsAvailable: 0
                    timestamp: '2025-10-29T10:30:00.000Z'

  /mcp:
    post:
      summary: MCP JSON-RPC endpoint
      description: |
        Handles MCP protocol JSON-RPC messages.

        This endpoint is managed by StreamableHTTPServerTransport from @modelcontextprotocol/sdk.
        It supports both direct JSON responses and SSE streaming based on client capabilities.

        **Note**: This is the MCP protocol endpoint. For detailed MCP protocol specification,
        see https://spec.modelcontextprotocol.io/
      operationId: mcpJsonRpc
      tags:
        - MCP
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JSONRPCRequest'
            examples:
              listTools:
                summary: List available tools
                value:
                  jsonrpc: '2.0'
                  id: 1
                  method: tools/list
              callTool:
                summary: Call TPASS calculator tool
                value:
                  jsonrpc: '2.0'
                  id: 2
                  method: tools/call
                  params:
                    name: calculate_tpass_value
                    arguments:
                      rides: 42
                      month: 11
                      year: 2025
      responses:
        '200':
          description: Successful JSON-RPC response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JSONRPCResponse'
            text/event-stream:
              schema:
                type: string
                description: SSE stream of JSON-RPC messages
              examples:
                sseStream:
                  value: |
                    id: 1
                    event: message
                    data: {"jsonrpc":"2.0","id":2,"result":{"content":[{"type":"text","text":"..."}]}}

        '400':
          description: Invalid JSON-RPC request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JSONRPCError'
        '404':
          description: Session not found (stateful mode only)
        '405':
          description: Method not allowed

    get:
      summary: MCP SSE stream endpoint
      description: |
        Establishes Server-Sent Events stream for receiving MCP messages.

        Used by clients that want to receive streamed responses and notifications.
        Managed by StreamableHTTPServerTransport.
      operationId: mcpSseStream
      tags:
        - MCP
      parameters:
        - name: Last-Event-ID
          in: header
          description: ID of last received event (for resumability)
          required: false
          schema:
            type: string
      responses:
        '200':
          description: SSE stream established
          content:
            text/event-stream:
              schema:
                type: string
                description: Stream of SSE events containing JSON-RPC messages

    delete:
      summary: Close MCP session
      description: |
        Terminates an MCP session (stateful mode only).

        In stateless mode (current configuration), this returns 405.
      operationId: closeSession
      tags:
        - MCP
      responses:
        '200':
          description: Session closed successfully
        '404':
          description: Session not found
        '405':
          description: Method not allowed (stateless mode)

components:
  schemas:
    HealthCheckResponse:
      type: object
      required:
        - status
        - server
        - mcp
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Overall server health status
        server:
          type: object
          required:
            - name
            - version
            - uptime
          properties:
            name:
              type: string
              description: Server application name
            version:
              type: string
              description: Server version
            uptime:
              type: number
              description: Server uptime in seconds
        mcp:
          type: object
          required:
            - connected
            - toolsAvailable
          properties:
            connected:
              type: boolean
              description: MCP transport connection status
            toolsAvailable:
              type: integer
              description: Number of registered MCP tools
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp

    JSONRPCRequest:
      type: object
      required:
        - jsonrpc
        - method
      properties:
        jsonrpc:
          type: string
          enum: ['2.0']
        id:
          oneOf:
            - type: string
            - type: number
          description: Request identifier
        method:
          type: string
          description: MCP method name
          examples:
            - tools/list
            - tools/call
            - initialize
        params:
          type: object
          description: Method-specific parameters
          additionalProperties: true

    JSONRPCResponse:
      type: object
      required:
        - jsonrpc
      properties:
        jsonrpc:
          type: string
          enum: ['2.0']
        id:
          oneOf:
            - type: string
            - type: number
          nullable: true
        result:
          description: Successful result
        error:
          $ref: '#/components/schemas/JSONRPCErrorObject'

    JSONRPCError:
      type: object
      required:
        - jsonrpc
        - error
      properties:
        jsonrpc:
          type: string
          enum: ['2.0']
        id:
          oneOf:
            - type: string
            - type: number
          nullable: true
        error:
          $ref: '#/components/schemas/JSONRPCErrorObject'

    JSONRPCErrorObject:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          description: Error code
        message:
          type: string
          description: Error message
        data:
          description: Additional error data

tags:
  - name: MCP
    description: Model Context Protocol endpoints
  - name: Monitoring
    description: Server health and monitoring endpoints
